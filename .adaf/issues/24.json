{
  "id": 24,
  "title": "TUI input handling broken in tmux: replace hand-rolled key processing with Bubbles components",
  "description": "## Problem\n\nThe TUI feels broken when running inside tmux: Escape key sometimes doesn't register, input feels laggy, and navigation is unreliable. Other Bubble Tea applications work fine in tmux, so this is specific to how ADAF handles input.\n\n## Root Cause\n\nThe TUI implements its own character-by-character text input handling instead of using Bubble Tea's standard `textinput` and `textarea` components from the `bubbles` library. This causes three specific problems:\n\n### 1. Escape sequence ambiguity\n\ntmux delays `ESC` (default 500ms, but even low values like 10ms trigger it) to disambiguate standalone Escape keypresses from multi-byte escape sequences (e.g., arrow keys send `ESC [ A`). The Bubbles `textinput` component is designed around Bubble Tea's internal input reader which handles this gracefully. The raw `msg.String() == \"esc\"` check used throughout the TUI does not — it races with tmux's escape buffering, causing missed or misrouted keypresses.\n\n### 2. No input debouncing or buffering\n\nThe hand-rolled input appends characters one at a time with no batching:\n\n```go\ndefault:\n    if len(msg.String()) == 1 {\n        m.profileNameInput += msg.String()\n    }\n```\n\nUnder tmux's slightly delayed input delivery, keystrokes can feel sluggish or arrive out of order.\n\n### 3. 62+ states with individual key handlers\n\nEvery application state has its own `switch` on key strings. A slightly delayed or reordered escape sequence can land in the wrong handler if a state transition is in flight. This is fragile and hard to reason about.\n\n## Locations\n\n- `internal/tui/app.go` — Main Update() dispatch and all state-specific update functions (62+ states, each with hand-rolled key handling)\n- `internal/tui/scroll.go` — Global scroll key interception\n- Program init at `app.go:1306` — Only uses `tea.WithAltScreen()`, no `tea.WithInputTTY()` or other input options\n\n## Proposed Fix\n\nReplace all hand-rolled text input handling with standard Bubbles components:\n\n1. **Use `textinput.Model`** from `github.com/charmbracelet/bubbles/textinput` for all single-line text fields (profile names, loop names, numeric inputs, IDs, etc.).\n2. **Use `textarea.Model`** from `github.com/charmbracelet/bubbles/textarea` for multi-line input (rule body editing in `stateSettingsRuleBody`).\n3. **Add `tea.WithInputTTY()`** to the program options to improve input handling when stdin is not a TTY (e.g., piped input scenarios).\n4. **Consolidate key handling** where possible — many states share identical key patterns (esc to go back, enter to confirm, j/k or up/down to navigate). Extract shared navigation helpers to reduce the per-state switch boilerplate.\n\nThis should significantly reduce code complexity while fixing the tmux input issues, since the Bubbles components already handle escape sequence timing, cursor movement, input buffering, and all the edge cases that the current hand-rolled implementation gets wrong.\n\n## Impact\n\nThis is a nontrivial refactor given the number of states, but it's mostly mechanical: identify each text input site, replace the manual buffer + switch logic with a `textinput.Model` field, and wire its `Update()` into the state handler. The navigation key handling (esc, enter, arrows, j/k) can remain manual since those are simple key checks — the main benefit comes from replacing the text input paths.\n\n## Related\n\n- Bubble Tea textinput: https://github.com/charmbracelet/bubbles/tree/master/textinput\n- Bubble Tea textarea: https://github.com/charmbracelet/bubbles/tree/master/textarea\n- tmux escape-time: https://man7.org/linux/man-pages/man1/tmux.1.html",
  "status": "resolved",
  "priority": "high",
  "labels": [
    "bug",
    "tui",
    "simplification",
    "tmux"
  ],
  "created": "2026-02-14T12:00:00Z",
  "updated": "2026-02-14T06:30:06.293368859Z"
}
