{
  "id": 45,
  "title": "Supervisor role prompt contradictions cause supervisor to write code",
  "description": "## Summary\n\nThe supervisor step in multi-step loops (e.g. opus-manager) ignores its role and starts writing code instead of supervising. Observed in session 94, turn 145: the supervisor spent ~7 minutes exploring the codebase, then wrote to `internal/webserver/static/index.html` before the turn was killed.\n\n## Root cause: three compounding problems\n\n### 1. Guardrails not enabled by default for non-coding roles\n\nThe supervisor step in the loop config has no `\"guardrails\": true`:\n\n```json\n{\n  \"profile\": \"opus 4.6\",\n  \"role\": \"supervisor\",\n  \"turns\": 1,\n  \"can_stop\": true,\n  \"can_message\": true\n}\n```\n\nWithout `\"guardrails\": true`, `guardrail.NewMonitor()` returns nil and zero write-blocking occurs. The role catalog defines `CanWriteCode: false` for supervisor, but this is only honored when guardrails are explicitly enabled per-step. A supervisor with full tool access and no runtime enforcement will eventually try to write.\n\n**Fix**: Guardrails should be implicitly enabled for any step where the role has `CanWriteCode: false`. The `NewMonitor()` call in `internal/looprun/runner.go:226-227` should check the role's `CanWriteCode` flag, not just `stepDef.Guardrails`. Alternatively, make `guardrails: true` the default for supervisor/scout/reviewer roles.\n\n### 2. Contradictory rules in the prompt\n\nThe prompt sent to the supervisor contains directly contradictory instructions:\n\n- **Role identity** (from `internal/config/role_catalog.go`):\n  \u003e \"You are a SUPERVISOR agent. You review progress and provide guidance via spawn messaging. You do NOT write code.\"\n\n- **General rules** (from `internal/prompt/builder.go` or rules catalog):\n  \u003e \"Write code, run tests, and ensure everything compiles before finishing.\"\n\nThese appear in the same prompt, a few lines apart. The general \"Write code...\" rule is included for all roles regardless of `CanWriteCode`. Claude resolves the contradiction by following the more actionable instruction.\n\n**Fix**: The \"Write code, run tests...\" rule should be conditional on `CanWriteCode`. Roles with `CanWriteCode: false` should get a different rule like \"Review work, check progress, and provide guidance to running agents.\"\n\n### 3. Objective is a developer task, not a review task\n\nThe prompt builder gives the supervisor the same plan-phase objective as the manager/developer:\n\n\u003e \"Your task is to work on phase p3-web-layout: Web Frontend: Reference UI Layout \u0026 Shell. Rebuild the web frontend to match the exact layout structure from reference-ui.jsx.\"\n\nThis is an implementation directive. Combined with \"You cannot spawn sub-agents\", the supervisor has no way to fulfill this objective without writing code itself.\n\n**Fix**: The objective for supervisor-role steps should be framed as a review: \"Review progress on phase p3-web-layout. Check if the manager's spawned agents completed the work correctly. Provide guidance or flag issues.\" The prompt builder should detect the role and adjust the framing accordingly.\n\n## Evidence\n\nRecording: `.adaf/local/records/145/recording.json`\n\nTool calls made by supervisor (turn 145):\n- 78 read-only calls (Glob, Read, Grep, Task) — exploring the codebase\n- Tool call #79: `Write` to `internal/webserver/static/index.html` (2677 chars) — succeeded because no guardrail\n- Tool call #80: `TodoWrite` — updating its task list\n- Turn ended with exit_code=-1 after ~7 minutes\n\nThe written file shows as `M internal/webserver/static/index.html` in git status.\n\n## Files involved\n\n- `internal/config/role_catalog.go` — role definitions, `CanWriteCode` flag, rule assignments\n- `internal/prompt/builder.go` — prompt assembly, rule inclusion logic\n- `internal/looprun/runner.go:226-227` — guardrail monitor creation\n- `internal/guardrail/guardrail.go` — `NewMonitor()` nil-return logic\n- `~/.adaf/config.json` — loop step definitions (user config)\n",
  "status": "open",
  "priority": "high",
  "labels": [
    "bug",
    "prompt",
    "guardrails",
    "supervisor"
  ],
  "created": "2026-02-14T16:38:06.084606007Z",
  "updated": "2026-02-14T16:38:06.084606007Z"
}