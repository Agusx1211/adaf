{
  "id": 45,
  "title": "Supervisor role prompt contradictions cause supervisor to write code",
  "description": "## Summary\n\nThe supervisor step in multi-step loops (e.g. opus-manager) ignores its role and starts writing code instead of supervising. Observed in session 94, turn 145: the supervisor spent ~7 minutes exploring the codebase, then wrote to `internal/webserver/static/index.html` before the turn was killed.\n\nThis is a **prompt engineering problem**, not a runtime enforcement problem. The guardrail system (`internal/guardrail/`) is a band-aid over a badly constructed prompt — if the supervisor understood its role clearly from the prompt alone, it wouldn't try to write code in the first place. The guardrail system should be removed; the fix is making the prompt unambiguous.\n\n## Root cause: contradictory and confusing prompt\n\nThe prompt sent to the supervisor makes it impossible for the agent to clearly understand its role due to multiple contradictions:\n\n### 1. Contradictory rules in the same prompt\n\nIn the same prompt, a few lines apart:\n\n- **Role identity** (from `internal/config/role_catalog.go`):\n  \u003e \"You are a SUPERVISOR agent. You review progress and provide guidance via spawn messaging. You do NOT write code.\"\n\n- **General rules** (included for ALL roles regardless of `CanWriteCode`, from the rules catalog):\n  \u003e \"Write code, run tests, and ensure everything compiles before finishing.\"\n\nThe agent receives \"don't write code\" and \"write code\" in the same system prompt. It resolves the ambiguity by following the more actionable instruction. This is the primary cause.\n\n**Fix**: The \"Write code, run tests...\" rule must be conditional on the role. Roles with `CanWriteCode: false` should get a different rule, e.g. \"Review work, check progress, and provide guidance to running agents.\"\n\n### 2. Objective is a developer task, not a review task\n\nThe prompt builder gives the supervisor the exact same plan-phase objective as the manager/developer:\n\n\u003e \"Your task is to work on phase p3-web-layout: Web Frontend: Reference UI Layout \u0026 Shell. Rebuild the web frontend to match the exact layout structure from reference-ui.jsx.\"\n\nThis is an implementation directive. Combined with \"You cannot spawn sub-agents\", the supervisor has literally no way to fulfill this objective without writing code itself. The prompt is setting the agent up to fail.\n\n**Fix**: The objective for supervisor-role steps should be reframed as review/guidance: \"Review progress on phase p3-web-layout. Check if the manager's spawned agents completed the work correctly. Verify the build passes. Provide guidance or flag issues via `adaf loop message`.\"\n\n### 3. Remove the guardrail system\n\nThe runtime guardrail system (`internal/guardrail/`) is a workaround for bad prompts. If the prompt clearly communicates the role, the agent won't attempt writes. Runtime interception is brittle (the first write still goes through before detection), adds code complexity, and masks the real problem. Delete it and fix the prompts instead.\n\n## Evidence\n\nRecording: `.adaf/local/records/145/recording.json`\n\nTool calls made by supervisor (turn 145):\n- 78 read-only calls (Glob, Read, Grep, Task) — exploring the codebase\n- Tool call #79: `Write` to `internal/webserver/static/index.html` (2677 chars) — went through, no guardrail stopped it\n- Tool call #80: `TodoWrite` — updating its task list\n- Turn ended with exit_code=-1 after ~7 minutes\n\nThe written file shows as `M internal/webserver/static/index.html` in git status.\n\n## Action items\n\n1. Make the \"Write code, run tests...\" rule conditional on `CanWriteCode` in `internal/config/role_catalog.go`\n2. Reframe the objective in `internal/prompt/builder.go` for non-coding roles (supervisor, reviewer, scout) to be review-oriented instead of implementation-oriented\n3. Delete `internal/guardrail/` and remove its integration from `internal/looprun/runner.go`\n\n## Files involved\n\n- `internal/config/role_catalog.go` — role definitions, rule assignments; the \"Write code...\" rule must be excluded for non-coding roles\n- `internal/prompt/builder.go` — prompt assembly; objective framing must vary by role\n- `internal/guardrail/` — remove entirely\n- `internal/looprun/runner.go` — remove guardrail monitor integration\n",
  "status": "resolved",
  "priority": "high",
  "labels": [
    "bug",
    "prompt-engineering"
  ],
  "created": "2026-02-14T16:38:06.084606007Z",
  "updated": "2026-02-14T19:06:20.394080058Z"
}