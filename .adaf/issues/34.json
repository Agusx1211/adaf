{
  "id": 34,
  "title": "Gemini stream-json deltas are rendered as fragmented tiny chunks in runtui",
  "description": "## Summary\nGemini output appears broken into many tiny chunks in the runtime TUI (especially in `Detail -\u003e Last Msg` and raw event views), even when it is one coherent assistant response.\n\n## Observed During Dogfooding\n- Session: spawn `#4` (`gemini-flash`, scout role) in loop run `#5` on **2026-02-14**.\n- The right panel showed an assistant report split across many tiny fragments instead of a coherent message.\n- Recorded evidence in session output:\n  - `.adaf/records/9/events.jsonl:83`\n  - `.adaf/records/9/events.jsonl:84`\n  - `.adaf/records/9/events.jsonl:85`\n  - ...through `.adaf/records/9/events.jsonl:109`\n- Those lines are `{\"type\":\"message\", ..., \"role\":\"assistant\", ..., \"delta\":true}` fragments.\n\n## Root Cause Analysis\nThis appears to be a pipeline mismatch, not a single bug:\n\n1. ADAF invokes Gemini in stream-json mode:\n- `internal/agent/gemini.go:47` appends `--output-format stream-json`.\n\n2. Upstream Gemini CLI emits one JSONL event per streamed content chunk:\n- `references/gemini-cli/packages/cli/src/nonInteractiveCli.ts:317`\n- `references/gemini-cli/packages/cli/src/nonInteractiveCli.ts:327` sets `delta: true`.\n- Formatter writes each event immediately as one line:\n  - `references/gemini-cli/packages/core/src/output/stream-json-formatter.ts:20`\n  - `references/gemini-cli/packages/core/src/output/stream-json-formatter.ts:29`\n\n3. ADAF parser preserves event granularity line-by-line:\n- `internal/stream/gemini.go:154`\n- `internal/stream/gemini.go:168`\n- `internal/stream/gemini.go:189`\n\n4. In runtui raw JSON rendering path, Gemini `message` events are rendered as standalone text blocks and `delta` is parsed but not used for coalescing:\n- `internal/runtui/model.go:1924`\n- `internal/runtui/model.go:1939`\n- `internal/runtui/model.go:1941`\n\n5. Final-message aggregation stores each chunk as a separate assistant message entry, then joins with blank lines:\n- `internal/runtui/detail_layers.go:216`\n- `internal/runtui/detail_layers.go:217`\n- `internal/runtui/detail_layers.go:230`\n\n## Why It Looks Worse In \"Last Msg\"\nFor Gemini chunk streams, each chunk is treated as a discrete message segment; `latestAssistantMessage()` joins segments with `\"\\n\\n\"`, which amplifies fragmentation.\n\n## Expected Behavior\n- Streaming can stay incremental in raw/live view, but final message surfaces should show a coherent assistant response.\n- `delta: true` events should be accumulated/coalesced before being treated as full assistant-message boundaries.\n\n## Suggested Direction\nAny of these could work:\n- In `renderGeminiStreamLine`, if `delta=true`, append to a stream buffer (similar intent to `content_block_delta` path) instead of creating a new standalone message block.\n- Or coalesce consecutive Gemini delta chunks before calling `recordAssistantText`.\n- Keep raw event visibility, but separate “raw events” from “coalesced assistant message” derivation for Last Msg.\n\n## Impact\n- Main user-facing TUI quality issue for Gemini runs.\n- Makes audits/reviews harder because the final response is visually fragmented.",
  "status": "resolved",
  "priority": "high",
  "created": "2026-02-14T07:52:57.891740112Z",
  "updated": "2026-02-14T08:23:57.814067761Z"
}