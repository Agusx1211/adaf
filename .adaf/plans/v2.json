{
  "id": "v2",
  "title": "ADAF v2 - Web-Only, System Service, Reference UI",
  "description": "Major pivot: (1) Remove the Bubble Tea TUI entirely - ADAF becomes web-only for its interactive surface. (2) Rebuild the web frontend to precisely match reference-ui.jsx (Catppuccin Mocha palette, two-panel layout, agent tree, stream panel, communication panel, loop bar). (3) Transform ADAF from a per-project instance into a system-wide shared service that manages multiple projects from a single daemon. (4) General cleanup: remove dead code paths exposed by TUI removal, simplify the event protocol, drop charmbracelet dependencies, streamline the CLI to a thin client that talks to the daemon.",
  "status": "active",
  "phases": [
    {
      "id": "p1-tui-removal",
      "title": "Remove TUI \u0026 Charmbracelet Dependencies",
      "description": "Delete the entire Bubble Tea TUI and all charmbracelet library dependencies.\n\n**Step 1 - Extract shared event protocol:**\n- Move `internal/runtui/events.go` to a new `internal/events/` package. These 17 event types (AgentEventMsg, SpawnStatusMsg, LoopStepStartMsg, etc.) are the shared event protocol between the execution layer and the presentation layer — they are NOT TUI-specific.\n- Update all 10+ importers: `webserver/ws_handler.go`, `session/daemon.go`, `session/client.go`, `orchestrator/orchestrator.go`, `looprun/runner.go`, `cli/attach_cmd.go`, `cli/loop.go`, `cli/run.go`, `cli/ask.go`, and their test files.\n\n**Step 2 - Remove TUI entry point:**\n- In `cli/root.go`, remove the `tui.RunApp(s)` fallback when no subcommand is given. Replace with: if TTY and no command, print a brief status summary and suggest `adaf web` to open the dashboard.\n- Remove the `internal/tui` import from root.go.\n\n**Step 3 - Rewrite attach command:**\n- `cli/attach_cmd.go` currently creates a `runtui.Model` and wraps it in a Bubble Tea program. Replace this with a plain streaming output mode: connect to the session daemon via WebSocket, print events to stdout as formatted text (agent output, spawn status, loop progress). No Bubble Tea, no alt-screen.\n- Support `--json` flag for machine-readable NDJSON output.\n\n**Step 4 - Delete TUI packages:**\n- Delete `internal/tui/` entirely (20 files, ~316KB).\n- Delete `internal/runtui/` except for the already-moved `events.go` (10 remaining files, ~172KB).\n\n**Step 5 - Remove charmbracelet dependencies:**\n- Rewrite `internal/theme/colors.go` to use plain ANSI escape codes instead of lipgloss.\n- Remove from go.mod: `charmbracelet/bubbles`, `charmbracelet/bubbletea`, `charmbracelet/lipgloss`, `charmbracelet/x/ansi`, and all transitive deps.\n- Run `go mod tidy`.\n\n**Step 6 - Update CLAUDE.md:**\n- Remove all TUI-related sections from CLAUDE.md (the 'TUI First-Class' section, runtui references, etc.).\n- Update architecture diagram to remove tui/runtui packages.\n\n**Verification:** `make all` passes. No imports of charmbracelet remain. Event protocol works for webserver and session daemon.",
      "status": "not_started",
      "priority": 1
    },
    {
      "id": "p2-system-service",
      "title": "System-Wide Daemon Architecture",
      "description": "Transform ADAF from a per-project tool into a system-wide shared service.\n\n**Current state:** `adaf web` can already run in daemon mode (`--daemon`) and supports multi-project via a registry (`~/.adaf/web-projects.json`). Sessions are already globally scoped (`~/.adaf/sessions/`). Config is already global (`~/.adaf/config.json`). The foundation exists but requires polish.\n\n**Changes:**\n\n1. **Single daemon model**: The `adaf` CLI should detect a running daemon (via `~/.adaf/web.json`) and route operations through it. If no daemon is running, the CLI operates locally as today. Goal: one `adaf` daemon per user, always running.\n\n2. **Auto-registration**: When running any `adaf` command in a directory with `.adaf/project.json`, automatically register that project with the daemon's registry if not already registered. Remove the need for explicit `adaf web register`.\n\n3. **CLI as thin client**: For commands that modify state (plan create, issue create, session start, etc.), the CLI should prefer sending the request to the running daemon via its HTTP API rather than directly mutating the store. This ensures the web UI gets real-time updates. Fall back to direct store access when no daemon is running.\n\n4. **Project context in web UI**: The web UI header should show a project switcher. All API calls are project-scoped. The dashboard shows a cross-project overview.\n\n5. **Daemon lifecycle**: `adaf daemon start` starts the background daemon. `adaf daemon stop` stops it. `adaf daemon status` shows state. The `adaf web` command becomes an alias for `adaf daemon start --open-browser`. Consider auto-start on first CLI use.\n\n6. **Remove per-project assumption from CLI**: Commands like `adaf plan`, `adaf issue`, `adaf run` should work relative to CWD (detecting the nearest `.adaf/` upward), but route through the daemon when available.\n\n7. **Session-project binding**: Ensure sessions are tagged with their project ID so the web UI can filter sessions per project.",
      "status": "not_started",
      "priority": 1,
      "depends_on": [
        "p1-tui-removal"
      ]
    },
    {
      "id": "p3-web-layout",
      "title": "Web Frontend: Reference UI Layout \u0026 Shell",
      "description": "Rebuild the web frontend to match the exact layout structure from `reference-ui.jsx`. The current web UI uses a tab-based page navigation (Dashboard/Sessions/Plans/Issues/Docs/Config/Terminal tabs) which is fundamentally different from the reference design.\n\n**Target layout (from reference-ui.jsx):**\n\n```\n+-- Header Bar ------------------------------------------------+\n| logo | project-name | loop-name | usage (tokens/cost/turns)  |\n+-- Loop Bar --------------------------------------------------+\n| loop: name | status | cycle/step | step progression pills    |\n+-- Left Panel (380px) --+-- Right Panel (flex) ---------------+\n| View tabs: 1-5         | Detail tabs: Raw | Activity | Msgs  |\n| [Agents][Issues][Docs] | [scope filter] [auto-scroll toggle] |\n| [Plan][Logs]           |                                     |\n|                        | StreamPanel / ActivityFeed /         |\n| Active view content:   | CommunicationPanel                  |\n| - AgentTree            | (scrollable, filtered by scope)      |\n| - IssuesList           |                                     |\n| - PlanView             |                                     |\n| - LogsView             |                                     |\n| - DocsView             |                                     |\n|                        |                                     |\n| Footer: agent + time   | Status bar: view info, spawn stats  |\n+------------------------+-----------------------------------------+\n```\n\n**Implementation:**\n\n1. **Replace tab navigation** with the two-panel layout. Remove the current `\u003cnav\u003e` tab bar and separate page views.\n\n2. **Header bar**: project switcher dropdown (multi-project), active loop name, aggregated usage stats (input/output tokens, cost, turns).\n\n3. **Loop bar**: shows the active loop's name, status, current cycle/step, and step pills with checkmarks for completed steps. Conditionally visible only when a loop is running.\n\n4. **Left panel** (380px fixed width):\n   - 5 view tabs at top: Agents (1), Issues (2), Docs (3), Plan (4), Logs (5)\n   - Content area renders the active view\n   - Footer showing current selected agent and elapsed time\n\n5. **Right panel** (flex):\n   - 3 detail layer tabs: Raw, Activity, Messages\n   - Scope filter pill showing selected scope\n   - Auto-scroll toggle button\n   - Content area: StreamPanel (Raw), Activity timeline (Activity), CommunicationPanel (Messages)\n   - Status bar at bottom: current view/layer/detail info, spawn counts by status, message count\n\n6. **Design tokens** (from reference-ui.jsx):\n   - Catppuccin Mocha palette: base=#1e1e2e, mantle=#181825, crust=#11111b, surface0=#313244, etc.\n   - Fonts: JetBrains Mono for code/data, DM Sans for UI text\n   - Border radius: 4-8px, subtle box-shadow glows\n   - Transitions: 0.15s ease for hover states\n   - Animations: pulse (running status), spin (loading), fadeIn (new content)\n\n7. **Responsive**: on narrow screens, collapse to single-panel with a view switcher.\n\n**Keep:** vendor libs (xterm.js, marked.js, highlight.js), WebSocket infrastructure, existing API endpoints.",
      "status": "not_started",
      "priority": 1,
      "depends_on": [
        "p1-tui-removal"
      ]
    },
    {
      "id": "p4-agent-tree",
      "title": "Web Frontend: Agent Tree \u0026 Scope Selection",
      "description": "Implement the AgentTree component from `reference-ui.jsx` — this is the primary navigation element showing the hierarchy of sessions and spawns.\n\n**Sessions as top-level nodes:**\n- Show turn number (e.g. `turn #5`), profile name (colored with C.mauve), agent name\n- Status badge (StatusBadge component with color and icon)\n- Model name, elapsed time, current action in subtitle\n- Pulsing status dot when running\n- Expand/collapse chevron if session has spawns\n- Fork icon + spawn count badge if has children\n- Click to select scope (filters the right panel stream)\n\n**Spawns as nested tree nodes (recursive TreeNode):**\n- Depth-based indentation (20px per level)\n- Tree connector lines (vertical line + corner-down-right icon)\n- Spawn ID badge (#1, #2, etc.) in monospace\n- Profile + role display (e.g. `builder as developer`)\n- Status badge, elapsed time\n- Message count badge (if has parent/child messages)\n- Task description in subtitle\n- Git branch name with branch icon\n- Pending question alert block when status is `awaiting_input` and has a question\n- Recursive children rendering (spawns can spawn spawns)\n\n**Tree state management:**\n- `expandedNodes` set: tracks which nodes are expanded\n- `selectedScope` string: tracks which node is selected for scope filtering\n- Click handlers for expand/collapse and scope selection\n- Tree connectors calculated from depth and sibling position\n\n**Data flow:**\n- Fetch sessions from `/api/projects/{id}/sessions`\n- Fetch spawns from `/api/projects/{id}/spawns` (or dedicated endpoint)\n- Build parent-child hierarchy: spawns with `parent_spawn_id \u003e 0` nest under that spawn, others nest under session via `parent_turn_id`\n- Real-time updates via WebSocket events (SpawnStatusMsg, AgentStartedMsg, AgentFinishedMsg)\n\n**Interaction with right panel:**\n- Selecting a session sets scope to `session-{id}` which maps to `main` in stream events\n- Selecting a spawn sets scope to `spawn-{id}` which filters stream events to that spawn's output\n- Scope filter pill in right panel header shows the selected scope",
      "status": "not_started",
      "priority": 1,
      "depends_on": [
        "p3-web-layout"
      ]
    },
    {
      "id": "p5-stream-panel",
      "title": "Web Frontend: Stream Panel \u0026 Activity Feed",
      "description": "Implement the StreamPanel and Activity feed from `reference-ui.jsx` for the right panel's Raw and Activity tabs.\n\n**StreamPanel (Raw tab):**\n- Displays stream events filtered by the selected scope\n- Event types with distinct styling:\n  - `thinking`: italic, dimmed text (C.overlay1), with brain icon\n  - `text`: regular text (C.text)\n  - `tool_use`: highlighted with wrench icon, shows tool name + input (collapsible)\n  - `tool_result`: shows result text, dimmed background\n- Each event shows timestamp and scope badge\n- Scope-based color coding for multi-agent streams\n- Auto-scroll behavior: scroll to bottom on new events (toggleable via button)\n- Markdown rendering for text events (reuse marked.js)\n- Syntax highlighting for code in tool inputs/results (reuse highlight.js)\n\n**Activity feed (Activity tab):**\n- Timeline of high-level events:\n  - Session started/finished\n  - Spawn created/completed/failed\n  - Loop step transitions\n  - Messages sent between agents\n  - Plan/issue mutations\n- Each entry has: timestamp, icon, description, optional detail\n- Grouped by time proximity\n\n**CommunicationPanel (Messages tab):**\n- Shows parent-child messages for the selected scope\n- Direction indicators: up arrow for child-to-parent, down arrow for parent-to-child\n- Message type badges: `ask` (blue), `message` (green), `reply` (mauve)\n- Content rendered with markdown\n- Chronological order within the selected spawn's conversation\n\n**Data flow:**\n- Stream events arrive via WebSocket (existing ws_handler.go endpoint)\n- Activity events derived from session/spawn lifecycle events\n- Messages fetched from `/api/projects/{id}/messages` filtered by spawn\n\n**Performance:**\n- Virtualized scrolling for large event lists (or efficient DOM recycling)\n- Batch DOM updates to avoid layout thrashing\n- Limit retained events (e.g. last 5000) with ability to scroll back and load more",
      "status": "not_started",
      "priority": 1,
      "depends_on": [
        "p4-agent-tree"
      ]
    },
    {
      "id": "p6-project-views",
      "title": "Web Frontend: Plan, Issues, Docs, Logs Views",
      "description": "Implement the remaining left-panel views from `reference-ui.jsx`.\n\n**PlanView (tab 4):**\n- Plan title and overall status\n- Progress bar: percentage of completed phases with gradient fill (C.green to C.teal)\n- Phase list with:\n  - Phase ID and title\n  - Status badge (complete=green, in_progress=yellow, not_started=overlay0)\n  - Priority indicator\n  - Dependencies listed (depends_on phase IDs)\n  - Click to expand: full description with markdown rendering\n- Inline phase status editing (click status badge to cycle or dropdown)\n- Plan switcher if multiple plans exist\n\n**IssuesList (tab 2):**\n- Issue cards with:\n  - Priority indicator (color-coded: critical=red, high=peach, medium=yellow, low=green)\n  - Title\n  - Status badge\n  - Labels as small tags\n  - Created date\n- Click to expand: full description, edit controls\n- Create new issue button\n- Filter by status (open/closed/all)\n\n**DocsView (tab 3):**\n- Document list with title and created date\n- Click to view: full content rendered with markdown\n- Create/edit documents inline\n\n**LogsView (tab 5):**\n- Turn history showing:\n  - Turn hex ID\n  - Agent name and model\n  - Profile name\n  - Date and duration\n  - Build state (success/failure)\n  - Objective and what_was_built summaries\n  - Next steps\n- Expandable for full details\n- Filter by agent, profile, or build state\n\n**All views:**\n- Follow the reference-ui.jsx styling: Catppuccin colors, consistent spacing, monospace for IDs/numbers\n- Smooth transitions when switching between views\n- API endpoints already exist for all of these (from the v1-1 work)",
      "status": "not_started",
      "priority": 2,
      "depends_on": [
        "p3-web-layout"
      ]
    },
    {
      "id": "p7-session-control",
      "title": "Web Frontend: Session Control \u0026 Actions",
      "description": "Implement interactive session control from the web UI — starting, stopping, and interacting with sessions.\n\n**Start new session:**\n- Button/action to start a new session (ask, PM, or loop)\n- Profile picker: dropdown of configured profiles (agent + model + settings)\n- For ask mode: prompt text input with multi-line support\n- For PM mode: project manager agent selection\n- For loop mode: loop definition picker, optional cycle/step overrides\n- Model override option\n- Starts session via existing API endpoints (`/api/projects/{id}/sessions/ask`, `/pm`, `/loop`)\n\n**Stop session:**\n- Stop button on running sessions in the agent tree\n- Confirmation dialog\n- Uses existing stop endpoint\n\n**Send message to running session:**\n- Input box in the right panel when viewing a running session\n- Support sending messages to loop sessions (loop-message equivalent)\n- Support sending messages to spawns (spawn-message equivalent)\n- Uses existing message endpoints\n\n**Terminal integration:**\n- Terminal tab/panel using xterm.js (already implemented with pty_handler.go)\n- Accessible from the UI without being a separate page\n- Terminal runs in the project's working directory\n\n**Config management:**\n- Profile CRUD: create, edit, delete profiles\n- Loop CRUD: create, edit, delete loop definitions\n- Roles and rules management\n- Uses existing config API endpoints\n\n**Toast notifications:**\n- Session completed/failed notifications\n- Error toasts for failed API calls\n- Success confirmations for mutations",
      "status": "not_started",
      "priority": 2,
      "depends_on": [
        "p4-agent-tree"
      ]
    },
    {
      "id": "p8-cleanup",
      "title": "Codebase Cleanup \u0026 API Simplification",
      "description": "With the TUI removed and the system-service model in place, simplify the codebase.\n\n1. **CLI simplification:**\n   - Remove TUI-related CLI flags and options\n   - Remove `--tui` flags if any exist\n   - Simplify `root.go` now that the no-command case doesn't launch TUI\n   - Review all CLI commands for unnecessary complexity\n   - The `attach` command now just streams text, simplify its implementation\n\n2. **Event protocol cleanup:**\n   - Review `internal/events/` (moved from runtui) for TUI-specific event types that are no longer needed\n   - Remove `tickMsg` (was for TUI elapsed time display — webserver has its own timer)\n   - Remove `BackToSelectorMsg` (TUI navigation concept)\n   - Remove `DetachMsg` (TUI detach concept — attach cmd now just Ctrl+C)\n   - Simplify `SessionSnapshotMsg` and `SessionLiveMsg` if the webserver has its own snapshot model\n   - Keep all agent/spawn/loop events — these are the core protocol\n\n3. **Package cleanup:**\n   - Remove `internal/theme/` if no longer needed after charmbracelet removal (or simplify to just ANSI color constants)\n   - Review `internal/eventq/` — is it still needed without TUI?\n   - Check for any dead code paths that only existed to support TUI\n\n4. **Dependency audit:**\n   - `go mod tidy` to remove unused transitive deps\n   - Verify charmbracelet packages are fully gone\n   - Check if `isatty` is still needed (was used to decide TUI vs non-TTY)\n\n5. **Test cleanup:**\n   - Remove all TUI-specific tests (state transition tests, detach tests, etc.)\n   - Remove runtui model tests\n   - Update integration tests that assumed TUI behavior\n   - Ensure `make all` passes cleanly\n\n6. **Documentation:**\n   - Update README.md to reflect web-only architecture\n   - Update CLAUDE.md to remove TUI references, add web architecture section\n   - Update any inline documentation",
      "status": "not_started",
      "priority": 2,
      "depends_on": [
        "p2-system-service",
        "p3-web-layout"
      ]
    },
    {
      "id": "p9-polish",
      "title": "Integration Testing \u0026 Polish",
      "description": "Final integration pass ensuring everything works end-to-end.\n\n1. **End-to-end flow testing:**\n   - Start daemon, register multiple projects, verify web UI shows all\n   - Start a session from web UI, verify stream events appear in real-time\n   - Start a loop, verify loop bar, step progression, spawn tree\n   - Send messages to running sessions, verify delivery\n   - Stop sessions from web UI\n   - Verify CLI commands route through daemon when running\n   - Verify CLI works standalone when daemon is not running\n\n2. **Cross-project flows:**\n   - Multiple projects with concurrent sessions\n   - Project switcher in web UI\n   - Session list filtered by project\n   - Cross-project dashboard stats\n\n3. **Mobile responsiveness:**\n   - Test on narrow viewports\n   - Touch interactions for tree expand/collapse\n   - Readable on phone-sized screens\n\n4. **Performance:**\n   - Large session event streams (thousands of events)\n   - Many concurrent WebSocket connections\n   - Multiple projects with large stores\n\n5. **Error handling:**\n   - Daemon not running: graceful fallback\n   - Project store corrupted: clear error messages\n   - WebSocket disconnection: auto-reconnect with state recovery\n   - Agent binary not found: helpful errors in web UI\n\n6. **Match reference-ui.jsx audit:**\n   - Visual diff against reference-ui.jsx design\n   - Verify: color palette, fonts, spacing, animations, status indicators\n   - Verify: all interactive features from reference are implemented\n   - Verify: tree depth rendering, message badges, question alerts",
      "status": "not_started",
      "priority": 3,
      "depends_on": [
        "p5-stream-panel",
        "p6-project-views",
        "p7-session-control",
        "p8-cleanup"
      ]
    }
  ],
  "critical_path": [
    "p1-tui-removal",
    "p3-web-layout",
    "p4-agent-tree",
    "p5-stream-panel",
    "p9-polish"
  ],
  "created": "2026-02-14T15:37:30.322476305Z",
  "updated": "2026-02-14T15:37:34.720540983Z"
}