{
  "title": "ADAF v0.2 - Multi-Agent Orchestration Platform",
  "description": "Transform adaf from a basic agent runner into a full multi-agent orchestration platform. Key capabilities: (1) Auto-detect and manage installed agent coding systems (claude, codex, vibe, opencode) with per-agent model configuration. (2) Protocol system for defining multi-agent execution pipelines combining weak/cheap and powerful/expensive models. (3) Web dashboard for real-time monitoring and management of all agents across all projects. (4) Pushover notifications and Prometheus metrics via a persistent service. (5) Virtual AGENTS.md / CLAUDE.md injection system for transparent agent instruction management. The architecture follows a service-oriented design with a central daemon process that exposes REST/WebSocket APIs for the CLI, dashboard, and integrations.",
  "phases": [
    {
      "id": "p01",
      "title": "Agent Detection \u0026 Registry System",
      "description": "Build a system that auto-detects which agent coding tools are installed on the user's machine and manages their configurations.\n\n**Deliverables:**\n- `internal/detect/` package: Probe PATH and known install locations for claude, codex, vibe, opencode, and any generic agents\n- `detect.Scan()` returns `[]DetectedAgent` with: name, path, version (parsed from --version), capabilities, supported models\n- `internal/agent/models.go`: Per-agent model registry. Each agent type knows its available models (e.g., claude: opus-4, sonnet-4.5, haiku-4.5; codex: o3, o4-mini, gpt-4.1; opencode: supports multiple providers)\n- `adaf agents list` CLI command: Shows detected agents in a table with name, version, path, default model, available models\n- `adaf agents set-model \u003cagent\u003e \u003cmodel\u003e` CLI command: Configure which model each agent uses by default\n- `adaf agents test \u003cagent\u003e` CLI command: Run a quick health-check prompt to verify agent works\n- Store agent configs in `.adaf/agents.json` with detected info + user overrides\n- Add opencode agent implementation in `internal/agent/opencode.go` (wraps `opencode` CLI)\n- Update `internal/agent/registry.go` to auto-populate from detection results\n\n**Acceptance criteria:**\n- Running `adaf agents list` on a fresh machine correctly detects all installed agent tools\n- User can override default models per agent\n- Agent health-check verifies the tool is functional",
      "status": "not_started",
      "priority": 1
    },
    {
      "id": "p02",
      "title": "Protocol Engine - Multi-Agent Pipelines",
      "description": "Implement the protocol system that defines how multiple agents collaborate in a pipeline. Protocols are YAML/JSON definitions that specify execution graphs of agent steps.\n\n**Core concepts:**\n- A Protocol is a named, reusable execution plan (like a CI pipeline)\n- A Step is a single agent invocation with: agent type, model override, prompt template, working directory strategy, success criteria\n- Steps can run sequentially, in parallel (fan-out), or in loops\n- A Pipeline is a running instance of a Protocol\n\n**Deliverables:**\n- `internal/protocol/` package with types:\n  - `Protocol`: name, description, steps, variables\n  - `Step`: id, agent, model, prompt, depends_on, parallel_group, repeat, working_dir_strategy (main, worktree, clone)\n  - `StepResult`: output, exit_code, duration, artifacts\n- `internal/protocol/engine.go`: The execution engine that:\n  - Resolves step dependencies into an execution DAG\n  - Manages git worktrees for parallel agent execution\n  - Handles fan-out (one step spawns N parallel agents) and fan-in (merge results)\n  - Passes context/output between steps via template variables\n  - Supports retry policies and failure handling\n- `internal/protocol/builtin.go`: Built-in protocol templates:\n  - `simple-loop`: developer x N turns (current behavior)\n  - `dev-review`: developer -\u003e reviewer -\u003e developer (iterate until approved)\n  - `senior-junior`: senior plans -\u003e junior devs implement in worktrees -\u003e merge -\u003e senior reviews\n  - `tdd`: write tests (senior) -\u003e implement (junior) -\u003e run tests -\u003e iterate\n  - `full-team`: PM plans -\u003e senior architects -\u003e junior implements -\u003e QA reviews -\u003e PM accepts\n- `internal/worktree/` package: Git worktree lifecycle management (create, sync, merge, cleanup)\n- `adaf protocol list` CLI: Show available protocols\n- `adaf protocol show \u003cname\u003e` CLI: Show protocol details with step graph visualization\n- `adaf protocol create \u003cname\u003e` CLI: Create custom protocol from template or YAML\n- `adaf run --protocol \u003cname\u003e` CLI: Execute a protocol instead of simple loop\n- Protocol YAML format example:\n  ```yaml\n  name: senior-junior\n  steps:\n    - id: plan\n      agent: claude\n      model: opus\n      prompt: 'Analyze the task and create a detailed implementation plan with subtasks'\n    - id: impl-1\n      agent: codex\n      model: o4-mini\n      prompt: 'Implement subtask 1: {{plan.subtasks[0]}}'\n      depends_on: [plan]\n      working_dir: worktree\n    - id: impl-2\n      agent: claude\n      model: haiku\n      prompt: 'Implement subtask 2: {{plan.subtasks[1]}}'\n      depends_on: [plan]\n      working_dir: worktree\n    - id: merge\n      type: merge-worktrees\n      depends_on: [impl-1, impl-2]\n    - id: review\n      agent: claude\n      model: opus\n      prompt: 'Review merged changes for quality and correctness'\n      depends_on: [merge]\n  ```\n\n**Acceptance criteria:**\n- `adaf run --protocol dev-review` executes a multi-step protocol with developer and reviewer agents\n- Parallel steps use git worktrees and merge cleanly\n- Protocol execution state is persisted and can survive restarts\n- Step outputs are available to downstream steps via template variables",
      "status": "not_started",
      "priority": 1
    },
    {
      "id": "p03",
      "title": "Virtual Agent Instructions (AGENTS.md / CLAUDE.md Injection)",
      "description": "Build a system that transparently injects instructions, context, plans, and documentation into agents without modifying the user's actual AGENTS.md or ~/.claude/CLAUDE.md files.\n\n**Problem:**\nWhen adaf spawns an agent, it needs to provide context (current plan, assigned task, project docs, coding standards) but each agent reads instructions from different files (CLAUDE.md, AGENTS.md, .cursorrules, etc.).\n\n**Solution: Virtual overlay system**\n- Before spawning an agent, adaf:\n  1. Reads the real instruction file (if it exists)\n  2. Prepends/appends adaf-managed sections (delimited by markers)\n  3. Writes a combined temporary file\n  4. Sets the agent's working directory or env to use the virtual file\n  5. After the agent exits, restores the original file (or cleans up)\n\n**Deliverables:**\n- `internal/inject/` package:\n  - `inject.Manager`: Manages virtual instruction overlays\n  - `inject.Template`: Go templates for generating instruction sections\n  - `inject.AgentProfile`: Per-agent-type config for which files to inject and how\n    - Claude: `CLAUDE.md` in project root + `~/.claude/CLAUDE.md`\n    - Codex: `AGENTS.md` in project root\n    - Vibe: custom config injection\n    - OpenCode: instruction file injection\n  - `inject.Context`: Data available to templates (plan, current phase, assigned issues, recent decisions, project docs, step context from protocol)\n- `internal/inject/templates/` embedded templates:\n  - `orientation.md.tmpl`: Project overview, current state, what to work on\n  - `constraints.md.tmpl`: Coding standards, forbidden patterns, required patterns\n  - `task.md.tmpl`: Specific task assignment with context\n  - `protocol_step.md.tmpl`: Protocol step instructions with inter-step context\n- `adaf inject show \u003cagent\u003e` CLI: Preview what would be injected for an agent\n- `adaf inject set-template \u003cname\u003e` CLI: Customize injection templates\n- Safe cleanup: Use defer + signal handlers to ensure originals are always restored, even on crash\n- Backup originals to `.adaf/backups/` before any modification\n\n**Acceptance criteria:**\n- Agent spawned by adaf sees combined real+virtual instructions transparently\n- Original files are never corrupted, even if adaf crashes mid-execution\n- Templates have access to full project context (plan, issues, docs, decisions)\n- Each agent type's specific instruction file format is respected",
      "status": "not_started",
      "priority": 2
    },
    {
      "id": "p04",
      "title": "ADAF Daemon Service",
      "description": "Create a long-running daemon process that serves as the central nervous system for all adaf operations. This is the foundation for the web dashboard, Prometheus metrics, and Pushover notifications.\n\n**Deliverables:**\n- `internal/daemon/` package:\n  - `daemon.Server`: HTTP/WebSocket server (use stdlib net/http + gorilla/websocket or nhooyr.io/websocket)\n  - REST API endpoints:\n    - `GET /api/v1/projects` - List all known adaf projects on this machine\n    - `GET /api/v1/projects/:id/status` - Project status\n    - `GET /api/v1/projects/:id/agents` - Running agents for project\n    - `POST /api/v1/projects/:id/agents/:agent/stop` - Stop an agent\n    - `GET /api/v1/projects/:id/plan` - Current plan\n    - `GET /api/v1/projects/:id/issues` - Issues\n    - `GET /api/v1/projects/:id/logs` - Session logs\n    - `GET /api/v1/projects/:id/protocols` - Available protocols\n    - `POST /api/v1/projects/:id/run` - Start a protocol/agent run\n    - `GET /api/v1/metrics` - Prometheus metrics endpoint\n  - WebSocket endpoints:\n    - `WS /api/v1/projects/:id/stream` - Real-time agent output stream\n    - `WS /api/v1/events` - Global event bus (agent started, completed, failed, etc.)\n  - `daemon.ProjectRegistry`: Discovers and tracks all `.adaf/` projects on the machine\n    - Watches configured directories for `.adaf/project.json` files\n    - Maintains index at `~/.adaf/registry.json`\n- `cmd/adaf/daemon.go` or `adaf service start/stop/status` CLI commands\n- PID file management at `~/.adaf/daemon.pid`\n- Structured logging to `~/.adaf/daemon.log`\n- Graceful shutdown with in-flight request draining\n- Auto-start option via systemd unit file generation: `adaf service install`\n\n**Acceptance criteria:**\n- `adaf service start` launches daemon in background\n- REST API returns correct data for all endpoints\n- WebSocket streams real-time agent output\n- Multiple projects are tracked simultaneously\n- Daemon survives and recovers from individual agent crashes",
      "status": "not_started",
      "priority": 2
    },
    {
      "id": "p05",
      "title": "Web Dashboard",
      "description": "Build a mobile-friendly web dashboard that connects to the adaf daemon and provides real-time monitoring and management of all agents across all projects.\n\n**Deliverables:**\n- `internal/dashboard/` package:\n  - Embedded SPA (Single Page Application) served by the daemon\n  - Built with vanilla JS + lightweight framework (Alpine.js or htmx) to keep it simple and embeddable\n  - Or: Use Go templates with htmx for server-rendered reactive UI (simpler, no build step)\n- **Pages/Views:**\n  1. **Home / Overview**: All projects grid with status cards (like a Grafana home)\n     - Each card shows: project name, active agents, plan progress %, last activity\n     - Color-coded status (green=healthy, yellow=running, red=failed)\n  2. **Project Detail**: Deep dive into one project\n     - Plan progress with phase timeline\n     - Active agents with real-time output (terminal-like view)\n     - Issue board (kanban or list)\n     - Session history with expandable logs\n     - Protocol execution graph visualization\n  3. **Agent Console**: Live terminal view of a running agent\n     - WebSocket-powered real-time output\n     - ANSI color rendering (use xterm.js or similar)\n     - Ability to stop/restart agent\n  4. **Protocol Designer** (stretch): Visual protocol builder\n     - Drag-and-drop step arrangement\n     - Connect steps with dependency arrows\n     - Export to YAML\n  5. **Settings**: Configure agents, models, notification preferences\n- **Mobile-first responsive design:**\n  - Touch-friendly navigation\n  - Collapsible sidebar\n  - Swipe between projects\n  - Agent output scrolls properly on mobile\n- Static assets embedded in Go binary via `embed` package (single binary deployment)\n\n**Acceptance criteria:**\n- `adaf service start` also serves dashboard at http://localhost:PORT\n- Dashboard shows all projects with real-time status\n- Agent output streams in real-time via WebSocket\n- Works well on mobile browsers (iPhone/Android)\n- Single binary - no external dependencies or build steps needed",
      "status": "not_started",
      "priority": 3
    },
    {
      "id": "p06",
      "title": "Pushover Notifications Integration",
      "description": "Integrate Pushover push notifications so users get mobile alerts for important agent events.\n\n**Deliverables:**\n- `internal/notify/` package:\n  - `notify.Pushover` client: Wraps Pushover HTTP API\n  - `notify.Manager`: Routes events to notification channels with filtering\n  - `notify.Rule`: Configurable rules for what triggers notifications\n- Configuration in `~/.adaf/config.json` or `.adaf/project.json`:\n  ```json\n  {\n    \"notifications\": {\n      \"pushover\": {\n        \"user_key\": \"...\",\n        \"api_token\": \"...\",\n        \"rules\": [\n          {\"event\": \"agent_failed\", \"priority\": 1},\n          {\"event\": \"protocol_completed\", \"priority\": 0},\n          {\"event\": \"review_needed\", \"priority\": 1},\n          {\"event\": \"agent_idle_timeout\", \"priority\": 0}\n        ]\n      }\n    }\n  }\n  ```\n- Events that trigger notifications:\n  - Agent failed (non-zero exit)\n  - Protocol completed (all steps done)\n  - Protocol step needs human review\n  - Agent idle for too long\n  - Daily summary (digest of all activity)\n- `adaf notify test` CLI: Send test notification\n- `adaf notify configure` CLI: Interactive setup of Pushover keys and rules\n- Support notification sounds, priority levels, and Pushover supplementary URLs (link back to dashboard)\n\n**Acceptance criteria:**\n- User receives Pushover notification on phone when agent fails\n- Notification rules are configurable per-project and globally\n- Test command verifies integration works\n- Notifications include actionable links to dashboard",
      "status": "not_started",
      "priority": 3
    },
    {
      "id": "p07",
      "title": "Prometheus Metrics Integration",
      "description": "Expose Prometheus-compatible metrics for monitoring agent performance, costs, and system health.\n\n**Deliverables:**\n- `internal/metrics/` package:\n  - Uses `prometheus/client_golang` library\n  - Metrics exposed at `/api/v1/metrics` (or standard `/metrics`) on daemon\n- **Metrics to expose:**\n  - `adaf_agent_runs_total` (counter): Total agent invocations, labeled by agent, model, project, protocol, exit_code\n  - `adaf_agent_duration_seconds` (histogram): Agent execution duration, labeled by agent, model\n  - `adaf_agent_active` (gauge): Currently running agents, labeled by agent, model, project\n  - `adaf_protocol_runs_total` (counter): Protocol executions, labeled by protocol, status\n  - `adaf_protocol_duration_seconds` (histogram): Protocol execution duration\n  - `adaf_protocol_steps_total` (counter): Steps executed, labeled by protocol, step, status\n  - `adaf_issues_total` (gauge): Issue counts, labeled by project, status, priority\n  - `adaf_plan_progress` (gauge): Plan completion percentage, labeled by project\n  - `adaf_session_recordings_bytes` (counter): Storage used by recordings\n  - `adaf_tokens_estimated_total` (counter): Estimated token usage (parsed from agent output where possible)\n  - `adaf_cost_estimated_total` (counter): Estimated cost in USD (based on model pricing tables)\n  - `adaf_daemon_uptime_seconds` (gauge): Daemon uptime\n- `adaf metrics` CLI: Show current metric values in terminal\n- Grafana dashboard JSON template in `deploy/grafana/adaf-dashboard.json`\n- Prometheus scrape config example in `deploy/prometheus/`\n\n**Acceptance criteria:**\n- Prometheus can scrape metrics from running daemon\n- All key metrics are accurate and properly labeled\n- Grafana dashboard shows meaningful visualizations\n- Token/cost estimation works for at least claude and codex agents",
      "status": "not_started",
      "priority": 3
    },
    {
      "id": "p08",
      "title": "Global Configuration \u0026 Project Registry",
      "description": "Implement a global configuration system at `~/.adaf/` that manages machine-wide settings, discovered projects, and shared agent configurations.\n\n**Deliverables:**\n- `~/.adaf/config.json`: Global config file with:\n  - Default agent preferences\n  - Default model per agent\n  - Notification settings\n  - Dashboard port and auth settings\n  - Metrics settings\n  - Auto-discovery paths (directories to scan for .adaf projects)\n- `~/.adaf/registry.json`: Auto-maintained list of all projects:\n  - Project name, path, last activity timestamp\n  - Active agent count\n  - Quick status (healthy/failed/idle)\n- `adaf config get/set` CLI: Read/write global config values\n- `adaf projects list` CLI: List all registered projects across the machine\n- `adaf projects scan [path]` CLI: Scan a directory tree for .adaf projects\n- `adaf projects remove \u003cpath\u003e` CLI: Unregister a project\n- Config inheritance: project config overrides global config\n- Environment variable overrides: `ADAF_*` env vars override config values\n\n**Acceptance criteria:**\n- Global config is created on first run\n- Project registry auto-updates when adaf commands run\n- Config inheritance works (global -\u003e project -\u003e env -\u003e flags)\n- `adaf projects list` shows all projects with status",
      "status": "not_started",
      "priority": 2
    },
    {
      "id": "p09",
      "title": "Enhanced Agent Implementations \u0026 Model Management",
      "description": "Upgrade all agent implementations with proper model management, capability detection, and cost tracking.\n\n**Deliverables:**\n- Update `internal/agent/agent.go` interface:\n  - `ListModels() []Model` - Available models for this agent\n  - `DefaultModel() string` - Current default model\n  - `SetModel(model string)` - Override model\n  - `Capabilities() Capabilities` - What this agent can do (edit files, run commands, search, etc.)\n  - `EstimateCost(duration, tokens) float64` - Cost estimation\n- Model registry with pricing data (`internal/agent/models.go`):\n  - Claude: opus-4 ($15/$75), sonnet-4.5 ($3/$15), haiku-4.5 ($0.80/$4)\n  - Codex: o3 (priced), o4-mini (cheaper), gpt-4.1\n  - OpenCode: depends on configured provider\n  - Vibe: depends on configured model\n- Add `internal/agent/opencode.go`:\n  - Wraps `opencode` CLI\n  - Detects configured provider/model from opencode config\n- Update all agent implementations:\n  - Parse output for token usage hints (claude outputs tokens in verbose mode)\n  - Track cumulative cost per session\n  - Support model override per-run\n- `adaf models list` CLI: Show all available models across all agents with pricing\n- `adaf models set-default \u003cagent\u003e \u003cmodel\u003e` CLI: Set default model for agent\n\n**Acceptance criteria:**\n- All four agent types (claude, codex, vibe, opencode) are fully implemented\n- Model pricing is accurate and cost tracking works\n- Users can easily switch models per agent\n- Cost per session is tracked and visible in logs and dashboard",
      "status": "not_started",
      "priority": 2
    },
    {
      "id": "p10",
      "title": "Testing, Documentation \u0026 Dogfooding",
      "description": "Comprehensive testing, documentation, and using adaf to develop adaf.\n\n**Deliverables:**\n- Unit tests for all new packages (target \u003e80% coverage):\n  - `internal/detect/` - Mock PATH and binary detection\n  - `internal/protocol/` - Protocol parsing, DAG resolution, execution\n  - `internal/inject/` - Template rendering, file overlay, safe cleanup\n  - `internal/daemon/` - API endpoint handlers\n  - `internal/notify/` - Pushover client (mock HTTP)\n  - `internal/metrics/` - Metric registration and values\n  - `internal/worktree/` - Git worktree operations\n- Integration tests:\n  - Full protocol execution with mock agents\n  - Daemon start/stop lifecycle\n  - Dashboard API responses\n  - Multi-project registry management\n- `adaf` protocol definitions for developing adaf itself:\n  - `protocols/adaf-dev.yaml`: Protocol for adaf development\n  - Uses senior (opus) for planning/review, junior (haiku/codex) for implementation\n- Updated README.md with:\n  - Architecture overview\n  - Getting started guide\n  - Protocol authoring guide\n  - Dashboard screenshots\n  - API reference\n- CHANGELOG.md for v0.2\n\n**Acceptance criteria:**\n- All tests pass\n- adaf can orchestrate its own development using protocols\n- Documentation is comprehensive and accurate",
      "status": "not_started",
      "priority": 4
    }
  ],
  "updated": "2026-02-11T09:01:21.693060861Z"
}